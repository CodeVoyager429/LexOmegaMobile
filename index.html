<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LexOmega | Unified App</title>
<meta name="description" content="LexOmega ‚Äî legal intelligence: documents, mock trials, notary, case search, Ask Lex."/>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --text:#eaeaea; --muted:#b7b7b7;
    --accent:#ffd000; --accent-press:#e0b800; --line:#2a2a2a;
    --ok:#10b981; --warn:#f59e0b; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1180px;margin:0 auto;padding:0 18px}
  header{position:sticky;top:0;z-index:50;background:var(--panel);border-bottom:1px solid var(--line);box-shadow:0 2px 20px rgba(0,0,0,.25)}
  .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .badge{background:var(--accent);color:#111;font-weight:900;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;box-shadow:0 6px 16px rgba(255,208,0,.25)}
  .tabs{display:flex;gap:18px;flex-wrap:wrap}
  .tab{padding:10px 12px;border-radius:10px;border:1px solid var(--line);cursor:pointer;user-select:none}
  .tab.active{background:var(--accent);color:#111;border-color:transparent;font-weight:800}
  .banner{background:#0ea5a8;color:#0b0b0b;border-bottom:3px solid var(--accent)}
  .banner .wrap{display:flex;align-items:center;gap:10px;padding:10px 18px}
  .grid{display:grid;gap:18px;grid-template-columns:repeat(12,1fr)}
  .card{grid-column:span 12;background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  @media(min-width:900px){ .span6{grid-column:span 6} .span4{grid-column:span 4} }
  h1{margin:10px 0 6px;font-size:clamp(28px,4.6vw,40px);color:#3ce1ff}
  h2{margin:0 0 8px;font-size:clamp(20px,3.4vw,24px)}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:0;cursor:pointer;background:var(--accent);color:#111;font-weight:800;padding:10px 16px;border-radius:12px;box-shadow:0 10px 18px rgba(255,208,0,.15)}
  .btn:hover{transform:translateY(-1px)} .btn:active{background:var(--accent-press)}
  .ghost{background:transparent;border:1px solid var(--line);color:var(--text);box-shadow:none}
  input,textarea,select{width:100%;background:#121212;border:1px solid #262626;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  input:focus,textarea:focus,select:focus{border-color:#3b3b3b;box-shadow:0 0 0 3px rgba(255,208,0,.18)}
  textarea{min-height:110px;resize:vertical}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#151515;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  footer{border-top:3px solid var(--accent);margin-top:30px;background:#101010}
  .verse{padding:18px;text-align:center;color:var(--muted);max-width:900px;margin:0 auto}
  /* Ask Lex floating */
  .lex-fab{position:fixed;right:18px;bottom:18px;z-index:70;background:var(--accent);color:#111;border:0;border-radius:999px;width:56px;height:56px;display:grid;place-items:center;font-weight:900;box-shadow:0 14px 26px rgba(255,208,0,.22)}
  .drawer{position:fixed;inset:auto 0 0 auto;width:min(520px,92vw);transform:translateX(105%);transition:transform .25s ease-out;background:var(--panel);border-left:1px solid var(--line);box-shadow:var(--shadow);z-index:75}
  .drawer.open{transform:translateX(0)}
  .drawer header{position:sticky;top:0;border-bottom:1px solid var(--line)}
  .chatlog{padding:14px;height:min(60vh,540px);overflow:auto;display:flex;flex-direction:column;gap:10px}
  .msg{background:#111;border:1px solid #242424;border-radius:12px;padding:10px}
  .msg.me{background:#132; border-color:#243}
  .mini{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="wrap nav">
    <div class="brand"><div class="badge">L</div><span>LexOmega</span></div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="tools">Tools</div>
      <div class="tab" data-tab="documents">Documents</div>
      <div class="tab" data-tab="notary">Notary</div>
    </div>
  </div>
</header>

<div class="banner"><div class="wrap">üì¢ <b>10-day free trial</b>. No credit card required.</div></div>

<main class="wrap">
  <section id="home" class="grid">
    <div class="card span6">
      <h1>Welcome to LexOmega</h1>
      <p class="muted">The Future of Legal Intelligence</p>
      <div class="row">
        <button class="btn" id="btnLogin">Login</button>
        <button class="btn ghost" id="btnRegister">Create Account</button>
        <span class="pill">Status: <span id="authState">Signed out</span></span>
      </div>
    </div>
    <div class="card span6">
      <h2>Quick Actions</h2>
      <div class="row">
        <button class="btn" id="qaGenNDA">Generate NDA</button>
        <button class="btn ghost" id="qaMockTrial">Start Mock Trial</button>
      </div>
      <p class="mini muted">These call your live unified API.</p>
    </div>
  </section>

  <section id="dashboard" class="grid" hidden>
    <div class="card span6">
      <h2>Stats</h2>
      <div id="dashStats" class="muted">Signed in to see stats.</div>
    </div>
    <div class="card span6">
      <h2>Recent Documents</h2>
      <div id="dashDocs" class="muted">‚Äì</div>
    </div>
  </section>

  <section id="tools" class="grid" hidden>
    <div class="card span6">
      <h2>Case Search</h2>
      <input id="searchQuery" placeholder="e.g., Fourth Amendment traffic stop"/>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnSearch">Search</button>
      </div>
      <div id="searchResults" class="mini muted" style="margin-top:10px">‚Äì</div>
    </div>
    <div class="card span6">
      <h2>Mock Trial</h2>
      <textarea id="claim" placeholder="Enter plaintiff claim‚Ä¶"></textarea>
      <div style="height:8px"></div>
      <textarea id="defense" placeholder="Enter defense argument‚Ä¶"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnTrial">Simulate</button>
      </div>
      <div id="trialOut" class="mini muted" style="margin-top:10px">‚Äì</div>
    </div>
  </section>

  <section id="documents" class="grid" hidden>
    <div class="card span6">
      <h2>Your Documents</h2>
      <div class="row">
        <button class="btn" id="btnListDocs">Refresh List</button>
      </div>
      <div id="docList" class="mini muted" style="margin-top:10px">‚Äì</div>
    </div>
    <div class="card span6">
      <h2>Generate Document</h2>
      <div class="row"><input id="docType" placeholder="Type (e.g., NDA)"></div>
      <div class="row"><input id="partyA" placeholder="Party A"></div>
      <div class="row"><input id="partyB" placeholder="Party B"></div>
      <div class="row"><input id="jurisdiction" placeholder="Jurisdiction (optional)"></div>
      <div class="row"><textarea id="terms" placeholder="Key terms (optional)"></textarea></div>
      <div class="row"><button class="btn" id="btnGenDoc">Generate</button></div>
      <pre id="docOut" class="mini muted" style="white-space:pre-wrap;margin-top:10px">‚Äì</pre>
    </div>
  </section>

  <section id="notary" class="grid" hidden>
    <div class="card span6">
      <h2>Create Notary Session</h2>
      <div class="row"><input id="nDocId" placeholder="Document ID (from list)"></div>
      <div class="row"><input id="nName" placeholder="Signer full name"></div>
      <div class="row"><input id="nEmail" placeholder="Signer email"></div>
      <div class="row"><button class="btn" id="btnNotaryCreate">Create Session</button></div>
      <div id="notaryCreateOut" class="mini muted" style="margin-top:10px">‚Äì</div>
    </div>
    <div class="card span6">
      <h2>Lookup Notary Session</h2>
      <div class="row"><input id="nLookupId" placeholder="notary_XXXXXX"></div>
      <div class="row"><button class="btn ghost" id="btnNotaryGet">Get</button></div>
      <div id="notaryGetOut" class="mini muted" style="margin-top:10px">‚Äì</div>
    </div>
  </section>
</main>

<footer><div class="verse">‚ÄúI am the way, the truth, and the life.‚Äù ‚Äî John 14:6</div></footer>

<!-- Ask Lex floating panel -->
<button class="lex-fab" id="lexFab">üí¨</button>
<aside class="drawer" id="lexDrawer" aria-hidden="true">
  <header class="row" style="padding:10px 14px;justify-content:space-between;background:var(--panel)">
    <strong>Ask Lex</strong>
    <button class="btn ghost" id="lexClose">Close</button>
  </header>
  <div class="chatlog" id="chatLog"></div>
  <div style="padding:12px;border-top:1px solid var(--line)">
    <input id="lexInput" placeholder="Ask a question‚Ä¶ (Enter to send)"/>
  </div>
</aside>

<!-- Login Modal -->
<div id="loginModal" hidden style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);z-index:80">
  <div class="card" style="width:min(460px,92vw)">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="you@example.com" style="margin:6px 0">
    <input id="loginPassword" type="password" placeholder="Password" style="margin:6px 0">
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" data-close="loginModal">Cancel</button>
      <button class="btn" id="loginGo">Continue</button>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div id="registerModal" hidden style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);z-index:80">
  <div class="card" style="width:min(460px,92vw)">
    <h2>Create Account</h2>
    <input id="regName" placeholder="Full name" style="margin:6px 0">
    <input id="regEmail" placeholder="you@example.com" style="margin:6px 0">
    <input id="regPassword" type="password" placeholder="At least 8 chars (mixed case & number)" style="margin:6px 0">
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" data-close="registerModal">Cancel</button>
      <button class="btn" id="registerGo">Create Account</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   One-file controller (SPA)
   =========================== */
const API = '/api';
const storageKey = 'lexomega.auth';
const $ = (s,el=document)=>el.querySelector(s);
const $$= (s,el=document)=>[...el.querySelectorAll(s)];
const auth = {
  get(){ try{return JSON.parse(localStorage.getItem(storageKey))}catch{return null} },
  set(v){ localStorage.setItem(storageKey, JSON.stringify(v)); },
  clear(){ localStorage.removeItem(storageKey); }
};
function bearer(){ return auth.get()?.token ? { 'Authorization':'Bearer '+auth.get().token } : {}; }
function setAuthState(){
  const u = auth.get()?.user;
  $('#authState').textContent = u ? ('Signed in as ' + (u.username||u.email)) : 'Signed out';
}
function showTab(id){
  $$('#tabs .tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
  ['home','dashboard','tools','documents','notary'].forEach(x=> $('#' + x).hidden = (x!==id));
}
function toast(el, html){ el.innerHTML = '<span class="muted">'+html+'</span>'; }

/* ---------- Tabs ---------- */
$('#tabs').addEventListener('click',(e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  showTab(t.dataset.tab);
});

/* ---------- Modals ---------- */
function openModal(id){ $('#'+id).hidden=false; }
function closeModal(id){ $('#'+id).hidden=true; }
$$('[data-close]').forEach(b=> b.addEventListener('click', e=> closeModal(e.target.getAttribute('data-close'))));

/* ---------- Ask Lex drawer ---------- */
$('#lexFab').addEventListener('click', ()=> { $('#lexDrawer').classList.add('open'); $('#lexDrawer').ariaHidden='false'; $('#lexInput').focus(); });
$('#lexClose').addEventListener('click', ()=> { $('#lexDrawer').classList.remove('open'); $('#lexDrawer').ariaHidden='true'; });

function pushMsg(who, text){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='me'?'me':'bot');
  div.innerHTML = text.replace(/</g,'&lt;');
  $('#chatLog').appendChild(div);
  $('#chatLog').scrollTop = $('#chatLog').scrollHeight;
}

/* ---------- Fetch helper ---------- */
async function api(path, opts={}){
  const headers = { 'Content-Type':'application/json', ...bearer(), ...(opts.headers||{}) };
  const res = await fetch(API+path, { ...opts, headers });
  let data = null; try { data = await res.json(); } catch { data = null; }
  if (!res.ok || data?.ok===false) {
    const msg = data?.error?.message || (res.status+' '+res.statusText);
    throw new Error(msg);
  }
  return data;
}

/* ---------- Auth flows ---------- */
$('#btnLogin').addEventListener('click', ()=> openModal('loginModal'));
$('#btnRegister').addEventListener('click', ()=> openModal('registerModal'));

$('#loginGo').addEventListener('click', async ()=>{
  try{
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPassword').value;
    const out = await api('/auth/login',{ method:'POST', body: JSON.stringify({ email, password }) });
    auth.set(out.data || out); // supports both {ok,data:{token,user}} and {token,user}
    setAuthState(); closeModal('loginModal');
  }catch(e){ alert(e.message); }
});

$('#registerGo').addEventListener('click', async ()=>{
  try{
    const name = $('#regName').value.trim();
    const email = $('#regEmail').value.trim();
    const password = $('#regPassword').value;
    const out = await api('/auth/register',{ method:'POST', body: JSON.stringify({ name, email, password }) });
    auth.set(out.data || out);
    setAuthState(); closeModal('registerModal');
  }catch(e){ alert(e.message); }
});

/* ---------- Quick Actions ---------- */
$('#qaGenNDA').addEventListener('click', async ()=>{
  try{
    const idem = cryptoRandom();
    const out = await api('/documents/generate',{
      method:'POST',
      headers:{ 'Idempotency-Key': idem },
      body: JSON.stringify({ type:'NDA', partyA:'Company A', partyB:'Company B', jurisdiction:'US' })
    });
    alert('Generated: ' + (out.data?.document?.title || out.document?.title));
  }catch(e){ alert(e.message); }
});

$('#qaMockTrial').addEventListener('click', async ()=>{
  try{
    const out = await api('/trial/simulate',{
      method:'POST',
      body: JSON.stringify({ claim:'Breach of contract regarding delivery terms.', defense:'Force majeure due to port closure.' })
    });
    $('#trialOut').textContent = out.data?.transcript || out.result?.transcript || JSON.stringify(out,null,2);
    showTab('tools');
  }catch(e){ alert(e.message); }
});

/* ---------- Dashboard ---------- */
async function loadDashboard(){
  try{
    const list = await api('/documents/list');
    $('#dashDocs').innerHTML = (list.data?.items || list.items || []).slice(0,5).map(d=>`‚Ä¢ ${d.title}`).join('<br>') || 'No docs yet.';
    $('#dashStats').innerHTML = `Docs: ${(list.data?.meta?.total ?? (list.items?.length||0))}`;
  }catch{ $('#dashDocs').textContent = 'Sign in to view.'; }
}

/* ---------- Tools: Search ---------- */
$('#btnSearch').addEventListener('click', async ()=>{
  const q = $('#searchQuery').value.trim();
  if (!q) return alert('Enter a query');
  try{
    const out = await api('/tools/search',{ method:'POST', body: JSON.stringify({ query:q }) });
    const items = out.data?.result?.items || out.result?.items || [];
    $('#searchResults').innerHTML = items.length
      ? items.map(i=>`<div class="msg"><b>${i.title}</b><br><span class="mini">${i.summary||''}</span></div>`).join('')
      : 'No results.';
  }catch(e){ alert(e.message); }
});

/* ---------- Tools: Trial ---------- */
$('#btnTrial').addEventListener('click', async ()=>{
  const claim = $('#claim').value.trim();
  const defense = $('#defense').value.trim();
  if(!claim||!defense) return alert('Enter claim and defense');
  try{
    const out = await api('/trial/simulate',{ method:'POST', body: JSON.stringify({ claim, defense }) });
    $('#trialOut').textContent = out.data?.transcript || out.result?.transcript || JSON.stringify(out,null,2);
  }catch(e){ alert(e.message); }
});

/* ---------- Documents ---------- */
$('#btnListDocs').addEventListener('click', loadDocs);
async function loadDocs(){
  try{
    const out = await api('/documents/list');
    const items = out.data?.items || out.items || [];
    $('#docList').innerHTML = items.length
      ? items.map(d=>`<div class="row" style="justify-content:space-between"><span>${d.title}</span><button class="btn ghost" data-doc="${d.id}">Open</button></div>`).join('')
      : 'No documents yet.';
  }catch(e){ $('#docList').textContent = e.message; }
}
$('#docList').addEventListener('click', async (e)=>{
  const id = e.target.getAttribute('data-doc'); if(!id) return;
  try{
    const res = await api('/documents/get?id='+encodeURIComponent(id));
    const md = res.data?.document?.markdown || res.document?.markdown || '(no content)';
    $('#docOut').textContent = md;
  }catch(e){ alert(e.message); }
});
$('#btnGenDoc').addEventListener('click', async ()=>{
  const type = $('#docType').value.trim();
  const partyA = $('#partyA').value.trim();
  const partyB = $('#partyB').value.trim();
  const jurisdiction = $('#jurisdiction').value.trim();
  const terms = $('#terms').value.trim();
  if(!type||!partyA||!partyB) return alert('Type, Party A, Party B required');
  try{
    const idem = cryptoRandom();
    const out = await api('/documents/generate',{
      method:'POST',
      headers:{ 'Idempotency-Key': idem },
      body: JSON.stringify({ type, partyA, partyB, jurisdiction, terms })
    });
    const md = out.data?.document?.markdown || out.document?.markdown || 'Generated.';
    $('#docOut').textContent = md;
    await loadDocs();
  }catch(e){ alert(e.message); }
});

/* ---------- Notary ---------- */
$('#btnNotaryCreate').addEventListener('click', async ()=>{
  const docId = $('#nDocId').value.trim();
  const signerName = $('#nName').value.trim();
  const signerEmail = $('#nEmail').value.trim();
  if (!docId||!signerName||!signerEmail) return alert('Fill all fields');
  try{
    const idem = cryptoRandom();
    const out = await api('/notary/create',{
      method:'POST',
      headers:{ 'Idempotency-Key': idem },
      body: JSON.stringify({ docId, signerName, signerEmail })
    });
    const s = out.data?.session || out.session;
    $('#notaryCreateOut').innerHTML = `Session: <b>${s.id}</b><br>Link: <a href="${s.link}" target="_blank">${s.link}</a>`;
  }catch(e){ alert(e.message); }
});
$('#btnNotaryGet').addEventListener('click', async ()=>{
  const id = $('#nLookupId').value.trim();
  if(!id) return alert('Enter notary id');
  try{
    const out = await api('/notary/get?id='+encodeURIComponent(id));
    const s = out.data?.session || out.session;
    $('#notaryGetOut').textContent = JSON.stringify(s,null,2);
  }catch(e){ alert(e.message); }
});

/* ---------- Ask Lex ---------- */
$('#lexInput').addEventListener('keydown', async (e)=>{
  if(e.key!=='Enter') return;
  const msg = e.target.value.trim(); if(!msg) return;
  pushMsg('me', msg); e.target.value='';
  try{
    const out = await api('/chat/assist',{ method:'POST', body: JSON.stringify({ message: msg }) });
    const reply = out.data?.reply || out.reply || '(no reply)';
    pushMsg('bot', reply);
  }catch(err){ pushMsg('bot', 'Error: '+err.message); }
});

/* ---------- Helpers ---------- */
function cryptoRandom(){
  // Quick Idempotency-Key generator
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a, b=>b.toString(16).padStart(2,'0')).join('');
}

/* ---------- Init ---------- */
(function init(){
  // optional backdoor: ?dev=1 seeds a session by calling /auth/login with demo user
  const params = new URLSearchParams(location.search);
  if(params.get('dev')==='1' && !auth.get()){
    // create demo quickly
    fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:'demo@lexomega.ai',password:'Password!23'})})
      .then(r=>r.json()).then(data=>{ auth.set(data.data||data); setAuthState(); loadDashboard(); })
      .catch(()=> setAuthState());
  } else {
    setAuthState();
    if(auth.get()) loadDashboard();
  }

  // Default tab after login
  $('#btnListDocs').click();
})();
</script>
</body>
</html>
