<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LexOmega | Unified Legal Intelligence</title>
  <meta name="description" content="LexOmega ‚Äî analytics, case tracking, document generation, notary, and real-time legal intelligence."/>
  <link rel="icon" href="data:,"/>
  <style>
    /* ===================== DESIGN TOKENS ===================== */
    :root{
      --bg:#0b0b0b;
      --panel:#141414;
      --panel-2:#101010;
      --text:#eee;
      --muted:#b7b7b7;
      --accent:#ffd000;
      --accent-press:#e0b800;
      --line:#2a2a2a;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --focus:0 0 0 3px rgba(255,208,0,.35);
      --shadow:0 18px 40px rgba(0,0,0,.45);
      --radius:14px;
    }

    /* ===================== BASE ===================== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.55;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .wrap{max-width:1100px;margin:0 auto;padding:0 18px}
    .row{display:flex;gap:22px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .muted{color:var(--muted)}
    .spacer{height:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#151515;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:18px 0}

    /* ===================== HEADER / NAV ===================== */
    header{
      position:sticky;top:0;z-index:50;background:var(--panel);
      border-bottom:1px solid var(--line);box-shadow:0 2px 18px rgba(0,0,0,.25)
    }
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .brand-badge{
      background:var(--accent);color:#111;font-weight:900;width:28px;height:28px;
      display:grid;place-items:center;border-radius:8px;box-shadow:0 6px 16px rgba(255,208,0,.25)
    }
    .nav-links{display:flex;gap:26px;align-items:center}
    .nav-links a{padding:8px 2px;position:relative;color:var(--text);opacity:.9}
    .nav-links a:hover{opacity:1}
    .nav-links a.active::after,.nav-links a:hover::after{
      content:"";position:absolute;left:0;right:0;bottom:-8px;height:3px;background:var(--accent);
      border-radius:2px;transform-origin:left;animation:underline .2s ease-out
    }
    @keyframes underline{from{transform:scaleX(.2)}to{transform:scaleX(1)}}
    .hamburger{display:none;border:1px solid var(--line);background:#1a1a1a;width:40px;height:40px;border-radius:10px}
    .hamburger span{display:block;width:20px;height:2px;background:var(--text);margin:6px auto}

    /* Drawer (mobile) */
    @media (max-width: 820px){
      .nav-links{display:none}
      .hamburger{display:block}
      .drawer{
        position:fixed;inset:0 0 0 auto;width:86%;max-width:360px;background:var(--panel);
        box-shadow:var(--shadow);transform:translateX(100%);transition:transform .25s ease-out;
        display:flex;flex-direction:column;z-index:60
      }
      .drawer.open{transform:translateX(0)}
      .drawer .links{display:flex;flex-direction:column;padding:22px}
      .drawer .links a{padding:14px 6px;border-bottom:1px solid var(--line)}
    }

    /* ===================== BANNER ===================== */
    .banner{background:#0ea5a8;color:#0b0b0b;font-weight:700;border-bottom:3px solid var(--accent)}
    .banner .wrap{display:flex;align-items:center;gap:12px;padding:10px 18px}
    .badge{font-size:20px}

    /* ===================== HERO & CARDS ===================== */
    .hero{padding:44px 0 20px}
    h1{font-size:clamp(32px,5vw,56px);margin:0 0 10px;color:#3ce1ff}
    .subhead{color:var(--muted);font-size:clamp(16px,2.4vw,20px)}
    .card{
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:22px
    }
    .card h2{margin:0 0 6px;font-size:clamp(22px,3.2vw,32px)}
    .cta-row{display:flex;gap:16px;margin-top:18px;flex-wrap:wrap}

    /* Buttons & Inputs */
    .btn{
      appearance:none;border:0;cursor:pointer;user-select:none;background:var(--accent);color:#111;
      font-weight:800;padding:12px 20px;border-radius:14px;box-shadow:0 10px 18px rgba(255,208,0,.15);
      transition:transform .06s ease,box-shadow .12s ease,background .12s ease
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{background:var(--accent-press);transform:translateY(0);box-shadow:0 6px 12px rgba(255,208,0,.12)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text);box-shadow:none}
    .btn.ghost:hover{border-color:#3b3b3b}
    input[type="email"],input[type="password"],input[type="text"],input[type="search"]{
      width:100%;background:#121212;border:1px solid #262626;color:var(--text);padding:12px 14px;border-radius:12px;outline:none
    }
    input:focus{box-shadow:var(--focus);border-color:#3b3b3b}

    /* ===================== MODALS ===================== */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:70;backdrop-filter:blur(2px)
    }
    .modal{
      width:min(520px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;
      padding:22px;box-shadow:var(--shadow);transform:translateY(6px);opacity:.98
    }
    .modal h3{margin:0 0 12px;font-size:20px}
    .modal .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}

    /* ===================== CHAT (Ask Lex) ===================== */
    .fab{
      position:fixed;right:18px;bottom:18px;background:var(--accent);color:#111;width:60px;height:60px;border-radius:999px;
      display:grid;place-items:center;font-weight:900;box-shadow:0 18px 36px rgba(255,208,0,.25);z-index:55;border:0;cursor:pointer
    }
    .chat{
      position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:3px solid var(--accent);box-shadow:var(--shadow);
      transform:translateY(100%);transition:transform .22s ease-out;z-index:65
    }
    .chat.open{transform:translateY(0)}
    .chat-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
    .chat-body{max-height:40vh;overflow:auto;padding:12px 16px}
    .chat-item{margin:8px 0}
    .chat-item.me{color:#d6f4ff}
    .chat-item.bot{color:#e8e8e8}
    .chat-input{display:flex;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}
    .chat-input input{flex:1}
    .mic{background:#1a1a1a;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:0 12px}

    /* ===================== TOAST ===================== */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:92px;background:#1d1d1d;color:var(--text);
      border:1px solid var(--line);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:80;display:none}
    .toast.show{display:block}
    footer{border-top:3px solid var(--accent);margin-top:36px;background:var(--panel-2)}
    .verse{padding:22px;text-align:center;color:var(--muted);max-width:900px;margin:0 auto}
  </style>
</head>
<body>

  <!-- Drawer (mobile) -->
  <nav class="drawer" id="drawer">
    <div class="links">
      <a href="#" data-nav="home" class="active">Home</a>
      <a href="dashboard.html" data-nav="dashboard">Dashboard</a>
      <a href="tools.html" data-nav="tools">Tools</a>
      <a href="documents.html" data-nav="documents">Documents</a>
      <a href="notary.html" data-nav="notary">Notary</a>
      <a href="#" data-nav="billing" id="drawerBilling">Billing</a>
    </div>
  </nav>

  <!-- Header -->
  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="brand-badge">L</div>
        <span>LexOmega</span>
      </div>
      <div class="nav-links" id="navLinks">
        <a href="#" class="active" data-nav="home">Home</a>
        <a href="dashboard.html" data-nav="dashboard">Dashboard</a>
        <a href="tools.html" data-nav="tools">Tools</a>
        <a href="documents.html" data-nav="documents">Documents</a>
        <a href="notary.html" data-nav="notary">Notary</a>
        <a href="#" data-nav="billing" id="navBilling">Billing</a>
      </div>
      <button class="hamburger" id="hamburger" aria-label="Open menu"><span></span><span></span><span></span></button>
    </div>
  </header>

  <!-- Banner -->
  <div class="banner">
    <div class="wrap">
      <span class="badge">üì¢</span>
      <div>LexOmega Launch Offer: <strong>10-day free trial</strong>. No credit card required.</div>
    </div>
  </div>

  <!-- Main -->
  <main class="wrap">
    <section class="hero">
      <h1>Welcome to LexOmega</h1>
      <div class="subhead">The Future of Legal Intelligence</div>
    </section>

    <section class="row">
      <!-- Live Dashboard Preview -->
      <article class="card col">
        <h2>Live Dashboard Preview</h2>
        <p class="muted">Analytics, case tracking, document generation and real-time alerts.</p>
        <div class="cta-row">
          <button class="btn" id="btnLogin">Login</button>
          <button class="btn ghost" id="btnCreate">Create Account</button>
          <button class="btn ghost" id="btnLogout" style="display:none">Logout</button>
          <!-- NEW: Stripe actions on the card -->
          <button class="btn" id="btnSubscribe">Subscribe</button>
          <button class="btn ghost" id="btnManageBilling">Manage Billing</button>
        </div>
        <div class="spacer"></div>
        <span class="pill">Status: <span id="authState">Signed out</span></span>
        <div class="hr"></div>
        <div id="statsBlock" class="muted">Loading stats‚Ä¶</div>
      </article>

      <!-- Embedded Legal Document Preview -->
      <article class="card col">
        <h2>Embedded Legal Document Preview</h2>
        <a class="muted" href="#" id="docLink"><strong>LexOmega ‚Äî Document Sample</strong></a>
        <div class="spacer"></div>
        <div style="height:180px;border:1px dashed #2e2e2e;border-radius:12px;display:grid;place-items:center;color:#7d7d7d;">
          <div>Document preview placeholder</div>
        </div>
        <div class="hr"></div>
        <div id="recentDocs" class="muted">Recent documents will appear here.</div>
      </article>
    </section>

    <!-- Case Search -->
    <section class="card" style="margin-top:22px">
      <h2>Case Search</h2>
      <p class="muted">Try: <em>‚ÄúFourth Amendment traffic stop‚Äù</em></p>
      <div class="row" style="align-items:flex-start">
        <div class="col">
          <input id="caseQuery" type="search" placeholder="Search cases‚Ä¶"/>
        </div>
        <div>
          <button class="btn" id="btnSearchCases">Search</button>
        </div>
      </div>
      <div id="caseResults" class="muted" style="margin-top:14px">Results will appear here.</div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="verse">
      ‚ÄúJesus said to him, 'I am the way, the truth, and the life. No one comes to the Father except through Me.'‚Äù ‚Äî John 14:6
    </div>
  </footer>

  <!-- Login Modal -->
  <div class="modal-backdrop" id="loginModal">
    <div class="modal">
      <h3 style="display:flex;justify-content:space-between;align-items:center;margin:0 0 12px">
        Login
        <button class="btn ghost" style="padding:6px 10px" data-close="loginModal" aria-label="Close">‚úï</button>
      </h3>
      <label class="muted" for="loginEmail">Email</label>
      <input id="loginEmail" type="email" placeholder="you@example.com"/>
      <div class="spacer"></div>
      <label class="muted" for="loginPassword">Password</label>
      <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      <div class="actions">
        <button class="btn ghost" data-close="loginModal">Cancel</button>
        <button class="btn" id="loginContinue">Continue</button>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal-backdrop" id="registerModal">
    <div class="modal">
      <h3 style="display:flex;justify-content:space-between;align-items:center;margin:0 0 12px">
        Create Account
        <button class="btn ghost" style="padding:6px 10px" data-close="registerModal" aria-label="Close">‚úï</button>
      </h3>
      <label class="muted" for="regName">Full name</label>
      <input id="regName" type="text" placeholder="Full name"/>
      <div class="spacer"></div>
      <label class="muted" for="regEmail">Email</label>
      <input id="regEmail" type="email" placeholder="you@example.com"/>
      <div class="spacer"></div>
      <label class="muted" for="regPassword">Password</label>
      <input id="regPassword" type="password" placeholder="At least 8 chars (mixed case & number)"/>
      <div class="actions" style="justify-content:space-between">
        <button class="btn ghost" data-close="registerModal">Cancel</button>
        <a id="guestContinue" class="muted" href="#" style="margin-right:auto;margin-left:10px">Continue as guest</a>
        <button class="btn" id="regContinue">Create Account</button>
      </div>
    </div>
  </div>

  <!-- Billing Modal -->
  <div class="modal-backdrop" id="billingModal">
    <div class="modal">
      <h3 style="display:flex;justify-content:space-between;align-items:center;margin:0 0 12px">
        Billing
        <button class="btn ghost" style="padding:6px 10px" data-close="billingModal" aria-label="Close">‚úï</button>
      </h3>
      <p class="muted">Manage your subscription.</p>
      <div class="actions" style="justify-content:flex-start">
        <button class="btn" id="modalSubscribe">Subscribe</button>
        <button class="btn ghost" id="modalPortal">Manage Billing</button>
      </div>
    </div>
  </div>

  <!-- Ask Lex FAB -->
  <button class="fab" id="fab" aria-label="Ask Lex">?</button>

  <!-- Ask Lex Chat -->
  <section class="chat" id="chat">
    <div class="chat-head">
      <strong>Ask Lex</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="mic" id="voiceToggle" title="Voice input">üé§</button>
        <button class="btn ghost" id="chatClose">Close</button>
      </div>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="chat-item bot">Hi! Ask anything like ‚ÄúGo to Tools‚Äù, ‚ÄúSearch: Miranda rights‚Äù, or ‚ÄúDraft an affidavit‚Äù.</div>
    </div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder='Ask anything. Try: "Go to Tools" or "Search Fourth Amendment".'/>
      <button class="btn" id="chatSend">Send</button>
    </div>
  </section>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    /* =========================================================
       FRONT-END CONTROLLER (wired to backend base URL)
       ========================================================= */

    // CHANGE THIS if your backend domain is different:
    const DEFAULT_BACKEND = 'https://lex-omega-backend.vercel.app';

    // Auto-detect: if this page is served from the backend domain, use same-origin.
    const SAME_ORIGIN_BACKEND = (()=>{
      try{
        const host = location.origin;
        return /lex-omega-backend\.vercel\.app$/.test(new URL(host).host) ? host : null;
      }catch{ return null; }
    })();

    // Allow manual override via ?backend=... for quick testing
    const urlBackend = new URLSearchParams(location.search).get('backend');
    const BACKEND = urlBackend || SAME_ORIGIN_BACKEND || DEFAULT_BACKEND;

    const API = {
      login: `${BACKEND}/api/auth/login`,
      register: `${BACKEND}/api/auth/register`,
      me: `${BACKEND}/api/auth/me`,
      stats: `${BACKEND}/api/dashboard/stats`,
      documentsList: `${BACKEND}/api/documents/list`,
      documentsGenerate: `${BACKEND}/api/documents/generate`,
      searchCases: `${BACKEND}/api/cases/search`,
      chat: `${BACKEND}/api/assistant/chat`,
      status: `${BACKEND}/api/status`,
      billingCheckout: `${BACKEND}/api/billing/checkout`,
      billingPortal: `${BACKEND}/api/billing/portal`
    };

    // ====== DOM helpers ======
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const drawer = qs('#drawer');
    const toast = qs('#toast');

    // ====== Cookies / CSRF ======
    function getCookie(name){
      const m = document.cookie.match('(?:^|; )' + name.replace(/([.$?*|{}()\\[\\]\\\\/+^])/g,'\\\\$1') + '=([^;]*)');
      return m ? decodeURIComponent(m[1]) : '';
    }
    async function ensureCsrf(){
      if(!getCookie('lo_csrf')){
        try{ await fetch(API.status, { method:'GET', credentials:'include' }); }catch{}
      }
    }

    // ====== Storage (session display; server keeps the real session) ======
    const storeKey = 'lexomega.user';
    const storage = {
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      get(k){ try{return JSON.parse(localStorage.getItem(k))}catch{return null} },
      del(k){ localStorage.removeItem(k); }
    };
    function currentUser(){ return storage.get(storeKey); }
    function saveUser(u){
      storage.set(storeKey, u || null);
      setAuthState(u);
      qs('#btnLogout').style.display = u ? 'inline-block' : 'none';
    }
    function signOutUI(){
      storage.del(storeKey);
      setAuthState(null);
      qs('#btnLogout').style.display = 'none';
    }
    function setAuthState(user){
      const state = qs('#authState');
      state.textContent = user ? 'Signed in as ' + (user.name || user.email || 'user') : 'Signed out';
    }

    // ====== Global fetch wrapper with credentials + CSRF ======
    async function apiFetch(url, opts={}){
      const method = (opts.method||'GET').toUpperCase();
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
      // Attach CSRF on state-changing requests
      if(!['GET','HEAD','OPTIONS'].includes(method)){
        await ensureCsrf();
        const token = getCookie('lo_csrf');
        if(token) headers['X-CSRF-Token'] = token;
      }
      const res = await fetch(url, Object.assign({}, opts, { headers, credentials:'include' }));
      if(res.status === 401){
        signOutUI();
        throw new Error('Session expired. Please sign in again.');
      }
      if(res.status === 405){
        throw new Error('Method not allowed (405) ‚Äî check backend route + method.');
      }
      if(!res.ok){
        let msg = 'Request failed: '+res.status;
        try{ const t = await res.text(); if(t) msg = t; }catch{}
        throw new Error(msg);
      }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ====== Drawer & nav ======
    qs('#hamburger').addEventListener('click',()=> drawer.classList.toggle('open'));
    drawer.addEventListener('click', e=>{ if(e.target.matches('a')) drawer.classList.remove('open'); });

    // ====== Modals ======
    function openModal(id){ const m=qs('#'+id); if(m) m.style.display='grid'; }
    function closeModal(id){ const m=qs('#'+id); if(m) m.style.display='none'; }
    qsa('[data-close]').forEach(btn=>btn.addEventListener('click', e=> closeModal(e.target.getAttribute('data-close')) ));
    qsa('.modal-backdrop').forEach(backdrop=>{
      backdrop.addEventListener('click',(e)=>{ if(e.target===backdrop) backdrop.style.display='none'; });
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ ['loginModal','registerModal','billingModal'].forEach(closeModal); } });

    // ====== Toasts ======
    let toastTimer;
    function showToast(msg, type='info'){
      toast.textContent = msg;
      toast.style.borderColor = type==='error'? 'var(--err)' : (type==='warn'? 'var(--warn)' : 'var(--line)');
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove('show'), 2600);
    }

    // ====== Auth flows ======
    qs('#btnLogin').addEventListener('click', ()=> openModal('loginModal'));
    qs('#btnCreate').addEventListener('click', ()=> openModal('registerModal'));
    qs('#btnLogout').addEventListener('click', async ()=>{
      try{
        await apiFetch(`${BACKEND}/api/auth/logout`, { method:'POST', body:JSON.stringify({}) });
      }catch{}
      signOutUI();
      showToast('Signed out');
    });

    qs('#guestContinue').addEventListener('click',(e)=>{
      e.preventDefault();
      closeModal('registerModal');
      saveUser({ id:'guest', email:'guest', name:'Guest', role:'guest' });
      showToast('Continuing as guest');
    });

    qs('#loginContinue').addEventListener('click', async ()=>{
      const email = qs('#loginEmail').value.trim();
      const password = qs('#loginPassword').value;
      try{
        if(!email || password.length<3) throw new Error('Enter email and password (‚â• 3 chars)');
        const data = await apiFetch(API.login, { method:'POST', body:JSON.stringify({email, password}) });
        saveUser(data?.user);
        closeModal('loginModal');
        showToast('Welcome back!');
        refreshAll();
      }catch(err){ showToast(err.message||'Login error','error'); }
    });

    qs('#regContinue').addEventListener('click', async ()=>{
      const name = qs('#regName').value.trim();
      const email = qs('#regEmail').value.trim();
      const password = qs('#regPassword').value;
      try{
        if(!name || !email || password.length<8) throw new Error('Please fill all fields (password ‚â• 8)');
        const data = await apiFetch(API.register, { method:'POST', body:JSON.stringify({name,email,password}) });
        saveUser(data?.user);
        closeModal('registerModal');
        showToast('Account created!');
        refreshAll();
      }catch(err){ showToast(err.message||'Registration error','error'); }
    });

    // ====== Billing (Stripe) ======
    function requireUserOrPrompt(){
      const u = currentUser();
      if(!u || u.id==='guest'){
        openModal('loginModal');
        showToast('Please sign in to continue', 'warn');
        return null;
      }
      return u;
    }
    async function doSubscribe(){
      if(!requireUserOrPrompt()) return;
      try{
        const r = await apiFetch(API.billingCheckout, { method:'POST', body:JSON.stringify({}) });
        if(r?.url) location.href = r.url;
        else throw new Error('No checkout URL returned.');
      }catch(err){ showToast(err.message||'Checkout failed','error'); }
    }
    async function openPortal(){
      if(!requireUserOrPrompt()) return;
      try{
        const r = await apiFetch(API.billingPortal, { method:'POST', body:JSON.stringify({}) });
        if(r?.url) location.href = r.url;
        else throw new Error('No portal URL returned.');
      }catch(err){ showToast(err.message||'Portal failed','error'); }
    }

    // Buttons on card
    qs('#btnSubscribe').addEventListener('click', doSubscribe);
    qs('#btnManageBilling').addEventListener('click', openPortal);
    // Nav + Drawer open billing modal
    qs('#navBilling').addEventListener('click', (e)=>{ e.preventDefault(); openModal('billingModal'); });
    qs('#drawerBilling').addEventListener('click', (e)=>{ e.preventDefault(); openModal('billingModal'); });
    // Modal buttons
    qs('#modalSubscribe').addEventListener('click', doSubscribe);
    qs('#modalPortal').addEventListener('click', openPortal);

    // Handle Stripe return params
    (function handleStripeReturns(){
      const p = new URLSearchParams(location.search);
      if(p.get('sub')==='success') showToast('Subscription activated. Welcome!', 'info');
      if(p.get('sub')==='cancel') showToast('Checkout canceled.', 'warn');
      if(p.get('portal')==='return') showToast('Returned from billing portal.', 'info');
    })();

    // ====== Data blocks ======
    async function loadStats(){
      try{
        const data = await apiFetch(API.stats, { method:'GET' });
        qs('#statsBlock').innerHTML = `
          <div class="pill">Cases: <strong>${data.cases||0}</strong></div>
          <div class="spacer"></div>
          <div class="pill">Documents: <strong>${data.documents||0}</strong></div>
          <div class="spacer"></div>
          <div class="pill">Alerts: <strong>${data.alerts||0}</strong></div>
        `;
      }catch(err){
        qs('#statsBlock').textContent = 'Unable to load stats.';
      }
    }

    async function loadRecentDocs(){
      try{
        const res = await apiFetch(API.documentsList, { method:'GET' });
        const list = res?.items || res || [];
        if(!list.length){ qs('#recentDocs').textContent='No recent documents.'; return; }
        qs('#recentDocs').innerHTML = list.slice(0,6).map(d=>`‚Ä¢ ${d.title} <span class="muted">(${new Date(d.created_at||d.createdAt||Date.now()).toLocaleDateString()})</span>`).join('<br/>');
      }catch(err){
        qs('#recentDocs').textContent = 'Unable to fetch documents.';
      }
    }

    qs('#btnSearchCases').addEventListener('click', async ()=>{
      const q = qs('#caseQuery').value.trim();
      if(!q){ showToast('Enter a case search query'); return; }
      qs('#caseResults').textContent = 'Searching‚Ä¶';
      try{
        const res = await apiFetch(API.searchCases, { method:'POST', body:JSON.stringify({ q }) });
        if(!res || !res.results || !res.results.length){
          qs('#caseResults').textContent = 'No results.';
          return;
        }
        qs('#caseResults').innerHTML = res.results.map(r=>{
          return `<div style="margin:10px 0"><strong>${r.citation||'Result'}</strong><div class="muted">${r.summary||''}</div></div>`;
        }).join('');
      }catch(err){
        qs('#caseResults').textContent = 'Search failed.';
        showToast(err.message,'error');
      }
    });

    qs('#docLink').addEventListener('click', async (e)=>{
      e.preventDefault();
      showToast('Generating sample‚Ä¶');
      try{
        const res = await apiFetch(API.documentsGenerate, { method:'POST', body:JSON.stringify({ type:'sample' }) });
        alert('Sample generated: '+ (res.title||'Document'));
      }catch(err){ showToast(err.message,'error'); }
    });

    // ====== Ask Lex (chat) ======
    const chat = qs('#chat');
    qs('#fab').addEventListener('click', ()=> chat.classList.toggle('open'));
    qs('#chatClose').addEventListener('click', ()=> chat.classList.remove('open'));

    async function sendChat(text){
      addChat('me', text);
      try{
        const res = await apiFetch(API.chat, { method:'POST', body:JSON.stringify({ message:text }) });
        handleVoiceCommand(text); // also treat as potential nav
        addChat('bot', res.reply || '‚Ä¶');
      }catch(err){
        addChat('bot', 'Error: '+(err.message||'request failed'));
      }
    }
    function addChat(who, text){
      const el = document.createElement('div');
      el.className = 'chat-item ' + who;
      el.textContent = text;
      const body = qs('#chatBody');
      body.appendChild(el);
      body.scrollTop = body.scrollHeight;
    }
    qs('#chatSend').addEventListener('click', ()=>{
      const val = qs('#chatInput').value.trim();
      if(!val) return;
      qs('#chatInput').value='';
      sendChat(val);
    });
    qs('#chatInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); qs('#chatSend').click(); }
    });

    // ====== Voice input + voice navigation ======
    let rec, listening=false;
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new SR();
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.onresult = (e)=>{
        const text = e.results[0][0].transcript;
        qs('#chatInput').value = text;
        sendChat(text);
      };
      rec.onend = ()=>{ listening=false; qs('#voiceToggle').textContent='üé§'; };
    } else {
      qs('#voiceToggle').disabled = true;
      qs('#voiceToggle').title = 'Voice not supported on this device';
    }
    qs('#voiceToggle').addEventListener('click', ()=>{
      if(!rec) return;
      if(!listening){ rec.start(); listening=true; qs('#voiceToggle').textContent='‚èπ'; }
      else { rec.stop(); }
    });

    // Simple voice navigation
    function handleVoiceCommand(text){
      const t = (text||'').toLowerCase();
      if(t.includes('go to tools') || t.includes('open tools')) location.href='tools.html';
      if(t.includes('go to documents') || t.includes('open documents')) location.href='documents.html';
      if(t.includes('go to dashboard') || t.includes('open dashboard')) location.href='dashboard.html';
      if(t.includes('open notary') || t.includes('go to notary')) location.href='notary.html';
      if(t.includes('open billing') || t.includes('go to billing')) openModal('billingModal');
    }

    // ====== Init ======
    (async function init(){
      // Ensure CSRF cookie exists early
      await ensureCsrf();

      // Restore UI identity if we have one
      const params = new URLSearchParams(location.search);
      if(params.get('dev')==='1'){
        saveUser({id:'u_demo', email:'demo@lexomega.ai', name:'demo', role:'user'});
      }else{
        const existing = currentUser();
        if(existing) saveUser(existing);
        else setAuthState(null);
      }

      // quick backend health ping (sets CSRF cookie too)
      try{
        await apiFetch(API.status, { method:'GET' });
      }catch{
        showToast('Backend not reachable. Check deployment / CORS.', 'warn');
      }

      await refreshAll();
    })();

    async function refreshAll(){
      await Promise.allSettled([loadStats(), loadRecentDocs()]);
    }
  </script>
</body>
</html>
