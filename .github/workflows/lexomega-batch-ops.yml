name: LexOmega â€“ Batch Ops

on:
  workflow_dispatch:
    inputs:
      ops:
        description: "Comma-separated ops to run (normalize,fmt,sitemap,assetcheck,linkaudit,commit)"
        required: false
        default: "normalize,fmt,sitemap,assetcheck,linkaudit,commit"

# Let the GITHUB_TOKEN push commits AND (if ever needed) touch workflows.
permissions:
  contents: write
  pull-requests: write
  actions: read
  workflows: write

jobs:
  run-ops:
    runs-on: ubuntu-latest
    env:
      SITE: ${{ secrets.SITE_DOMAIN }}
      OPS: ${{ github.event.inputs.ops }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # IMPORTANT: no caching option here (removes "Caching for 'none' is not supported")
      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Parse inputs
        id: steps
        shell: bash
        run: |
          # normalize commas/spaces
          OPS_CLEAN="$(echo "${OPS:-normalize,fmt,sitemap,assetcheck,linkaudit,commit}" | tr '[:upper:]' '[:lower:]' | tr -d ' ' )"
          echo "ops=$OPS_CLEAN" >> "$GITHUB_OUTPUT"

      - name: Install CLI tools
        shell: bash
        run: |
          set -e
          npm i -g prettier@3.3.3 linkinator@5.0.1 sitemap-generator-cli@6.2.2

      - name: Prepare SITE value
        shell: bash
        run: |
          set -e
          if [ -z "${SITE}" ]; then
            echo "SITE secret not set; falling back to repo Pages domain if any."
            SITE="https://${GITHUB_REPOSITORY_OWNER}.github.io"
          fi
          echo "Using SITE=${SITE}"

      - name: Normalize filenames (lowercase, no spaces)
        if: contains(steps.steps.outputs.ops, 'normalize')
        shell: bash
        run: |
          set -e
          git ls-files -z | xargs -0 -I {} bash -c '
            f="$1"
            lf="$(echo "$f" | tr "[:upper:]" "[:lower:]" | tr -s " " "-" )"
            if [ "$f" != "$lf" ]; then
              git mv -f "$f" "$lf"
            fi
          ' _ {}

      - name: Format code (Prettier)
        if: contains(steps.steps.outputs.ops, 'fmt')
        shell: bash
        run: |
          set -e
          prettier --ignore-unknown -w .

      - name: Generate sitemap.xml (best-effort)
        if: contains(steps.steps.outputs.ops, 'sitemap')
        continue-on-error: true
        shell: bash
        run: |
          set -e
          # Try crawl live site; if secret missing, skip gracefully
          if [ -n "${SITE}" ]; then
            echo "Generating sitemap from ${SITE}"
            npx --yes sitemap-generator-cli@6.2.2 "${SITE}" --output sitemap.xml || true
          else
            echo "SITE not set; skipping sitemap generation."
          fi

      - name: Asset check (local)
        if: contains(steps.steps.outputs.ops, 'assetcheck')
        shell: bash
        run: |
          test -f sitemap.xml && echo "sitemap.xml present" || echo "sitemap.xml not found (ok)"

      - name: Link audit (external)
        if: contains(steps.steps.outputs.ops, 'linkaudit')
        continue-on-error: true
        shell: bash
        run: |
          if [ -n "${SITE}" ]; then
            echo "Running linkinator on ${SITE}"
            linkinator "${SITE}" --recurse --skip "mailto:,tel:" || true
          else
            echo "SITE not set; skipping external link audit."
          fi

      - name: Commit & push changes
        if: contains(steps.steps.outputs.ops, 'commit')
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage all but workflow files to avoid "bot updating workflow" rejections.
          git add -A
          git reset -- .github/workflows/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore(batch-ops): apply fmt/normalize and generated artifacts"
          git push origin "${GITHUB_REF_NAME:-main}"
