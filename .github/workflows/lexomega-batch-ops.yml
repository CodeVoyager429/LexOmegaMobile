name: LexOmega – Batch Ops

on:
  workflow_dispatch:
    inputs:
      ops:
        description: "Comma-separated list of operations to run (e.g., normalize,fmt,sitemap,assetcheck,linkaudit,commit)"
        required: true
        default: "normalize,fmt,sitemap,assetcheck,linkaudit,commit"

jobs:
  batch-ops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install CLI tools
        run: |
          set -e
          npm install -g prettier
          # Try sitemap-generator-cli, fallback to sitemap
          if ! npm install -g sitemap-generator-cli@latest; then
            echo "⚠️ sitemap-generator-cli not available, installing 'sitemap' instead"
            npm install -g sitemap
          fi

      - name: Run batch ops
        run: |
          set -e
          OPS="${{ github.event.inputs.ops }}"
          echo "🚀 Running ops: $OPS"

          if [[ "$OPS" == *"normalize"* ]]; then
            echo "📦 Normalizing package.json"
            npx sort-package-json
          fi

          if [[ "$OPS" == *"fmt"* ]]; then
            echo "✨ Formatting code with Prettier"
            prettier --write "**/*.{js,ts,jsx,tsx,json,md}"
          fi

          if [[ "$OPS" == *"sitemap"* ]]; then
            echo "🌐 Generating sitemap.xml"
            if command -v sitemap-generator-cli > /dev/null; then
              echo "✅ Using sitemap-generator-cli"
              sitemap-generator-cli https://your-site-url.com -o ./sitemap.xml || echo "⚠️ sitemap generation failed"
            elif command -v sitemap > /dev/null; then
              echo "✅ Using fallback 'sitemap' package"
              sitemap https://your-site-url.com > ./sitemap.xml || echo "⚠️ sitemap fallback generation failed"
            else
              echo "❌ No sitemap generator found, skipping"
            fi
          fi

          if [[ "$OPS" == *"assetcheck"* ]]; then
            echo "🖼️ Checking assets directory"
            ls -lh ./public || echo "⚠️ No public directory found"
          fi

          if [[ "$OPS" == *"linkaudit"* ]]; then
            echo "🔗 Auditing links (placeholder)"
            echo "Would run link check here..."
          fi

          if [[ "$OPS" == *"commit"* ]]; then
            echo "💾 Preparing commit"
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore(batch-ops): automated batch operations" || echo "ℹ️ Nothing to commit"
            git push
          fi
