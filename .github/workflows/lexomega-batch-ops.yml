name: LexOmega - Batch Ops

on:
  workflow_dispatch:
    inputs:
      ops:
        description: "Comma-separated ops to run (normalize,fmt,sitemap,assetcheck,linkaudit,commit)"
        required: true
        default: "normalize,fmt,sitemap,assetcheck,linkaudit,commit"

jobs:
  run-ops:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "Starting workflow for ${{ github.repository }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse inputs
        id: parse
        run: |
          echo "ops=${{ github.event.inputs.ops }}" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CLI tools
        run: |
          npm i -g prettier@3.3.3 linkinator@5.0.1 sitemap-generator-cli@7.5.0

      - name: Prepare SITE value
        run: echo "SITE=${{ secrets.SITE_DOMAIN }}" >> $GITHUB_ENV

      - name: Normalize filenames (lowercase, no spaces)
        if: contains(env.ops, 'normalize')
        run: |
          find . -type f -name "* *" | while read file; do
            newfile=$(echo $file | tr '[:upper:]' '[:lower:]' | tr -d ' ')
            if [ "$file" != "$newfile" ]; then
              git mv "$file" "$newfile" || true
            fi
          done

      - name: Format code (Prettier)
        if: contains(env.ops, 'fmt')
        run: prettier --write "**/*.{js,ts,json,md,yml,yaml}"

      - name: Generate sitemap.xml (best-effort)
        if: contains(env.ops, 'sitemap')
        run: |
          sitemap-generator $SITE --output ./sitemap.xml || echo "Sitemap generation skipped"

      - name: Asset check (local)
        if: contains(env.ops, 'assetcheck')
        run: |
          linkinator ./ --recurse --skip "https?://"

      - name: Link audit (external)
        if: contains(env.ops, 'linkaudit')
        run: |
          linkinator $SITE --recurse --skip "mailto:,tel:"

      - name: Commit & push changes
        if: contains(env.ops, 'commit')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(batch-ops): automated ops run [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
