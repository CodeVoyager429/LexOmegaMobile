name: LexOmega ‚Äî Batch Ops

on:
  workflow_dispatch:
    inputs:
      ops:
        description: "Comma-separated ops to run (normalize,fmt,sitemap,assetcheck,linkaudit,commit)"
        required: true
        default: "normalize,fmt,sitemap,assetcheck,linkaudit,commit"

jobs:
  run-ops:
    runs-on: ubuntu-latest
    env:
      SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}

    steps:
      - name: Set up job
        run: echo "Starting batch ops‚Ä¶"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse inputs
        id: steps
        run: echo "ops=${{ github.event.inputs.ops }}" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CLI tools
        run: |
          npm i -g prettier@3.3.3 linkinator@5.0.1 sitemap-generator-cli@7.5.0

      - name: Prepare SITE value
        run: echo "SITE=https://${SITE_DOMAIN}" >> $GITHUB_ENV

      # ---------- NORMALIZE ----------
      - name: Normalize filenames (lowercase, no spaces)
        if: contains(steps.steps.outputs.ops, 'normalize')
        run: |
          find . -type f -not -path "./.git/*" | while read -r f; do
            d="$(dirname "$f")"
            b="$(basename "$f")"
            nb="$(echo "$b" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' )"
            if [ "$b" != "$nb" ]; then
              git mv -f "$f" "$d/$nb" || true
            fi
          done

      # ---------- FMT ----------
      - name: Format code (Prettier)
        if: contains(steps.steps.outputs.ops, 'fmt')
        run: |
          prettier -w . --ignore-unknown || true

      # ---------- SITEMAP ----------
      - name: Generate sitemap.xml (best-effort)
        if: contains(steps.steps.outputs.ops, 'sitemap')
        run: |
          mkdir -p public
          OUT="sitemap.xml"
          npx --yes sitemap-generator-cli@7.5.0 "https://${SITE_DOMAIN}" --max-depth 3 --strip-query true --timeout 10000 > "$OUT" || true
          if [ -s "$OUT" ]; then
            echo "‚úÖ Generated $OUT"
          else
            echo "‚ö†Ô∏è Could not generate $OUT (site may be private/unreachable)."
            rm -f "$OUT" || true
          fi

      # ---------- LOCAL ASSET CHECK ----------
      - name: Asset check (local)
        if: contains(steps.steps.outputs.ops, 'assetcheck')
        run: |
          ls -1 **/*.html **/*.md 2>/dev/null | head -n 20 || true

      # ---------- EXTERNAL LINK AUDIT ----------
      - name: Link audit (external)
        if: contains(steps.steps.outputs.ops, 'linkaudit')
        run: |
          SITE_URL="https://${SITE_DOMAIN}"
          echo "üîç Crawling $SITE_URL"
          linkinator "$SITE_URL" --recurse --skip "mailto:,tel:" --verbosity error || true

      # ---------- COMMIT ----------
      - name: Commit & push changes
        if: contains(steps.steps.outputs.ops, 'commit')
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore(batch-ops): apply fmt/normalize and generated artifacts"
            git push
          else
            echo "No changes to commit."
          fi
